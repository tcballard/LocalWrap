<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalWrap</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
            font-size: 11px;
            background: #f0f0f0;
            color: #000;
            padding: 12px;
            min-height: 100vh;
        }
        
        .window {
            background: #f0f0f0;
            border: 1px solid #646464;
            max-width: 450px;
            margin: 20px auto;
            box-shadow: 1px 1px 0px #fff inset, -1px -1px 0px #818181 inset;
        }
        
        .titlebar {
            background: linear-gradient(to bottom, #0997ff 0%, #0053ee 100%);
            color: white;
            padding: 3px 8px;
            font-size: 11px;
            font-weight: normal;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .titlebar-text {
            display: flex;
            align-items: center;
        }
        
        .content {
            padding: 16px;
        }
        
        .section {
            margin-bottom: 16px;
        }
        
        .section-title {
            font-size: 11px;
            margin-bottom: 8px;
            color: #000;
        }
        
        .url-input {
            width: 100%;
            height: 22px;
            border: 2px inset #f0f0f0;
            padding: 2px 4px;
            font-size: 11px;
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
        }
        
        .button-group {
            text-align: right;
            margin-top: 16px;
        }
        
        .btn {
            background: #f0f0f0;
            border: 1px outset #f0f0f0;
            padding: 3px 16px;
            margin-left: 6px;
            font-size: 11px;
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
            cursor: pointer;
            min-width: 75px;
            height: 23px;
        }
        
        .btn:hover {
            background: #e5f3ff;
        }
        
        .btn:active {
            border: 1px inset #f0f0f0;
        }
        
        .btn-small {
            background: #f0f0f0;
            border: 1px outset #f0f0f0;
            padding: 2px 8px;
            margin-left: 3px;
            font-size: 10px;
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
            cursor: pointer;
            min-width: 40px;
            height: 18px;
        }
        
        .btn-small:hover {
            background: #e5f3ff;
        }
        
        .btn-small:active {
            border: 1px inset #f0f0f0;
        }
        
        
        .status-bar {
            background: #f0f0f0;
            border-top: 1px solid #818181;
            padding: 4px 8px;
            font-size: 10px;
            color: #000;
        }
        
        
        .version-info {
            font-size: 10px;
            color: #666;
            text-align: center;
            margin-top: 12px;
        }
        
        .terminal-output {
            background: #000;
            color: #00ff00;
            border: 1px inset #f0f0f0;
            padding: 6px;
            margin: 8px 0;
            font-family: 'Courier New', monospace;
            font-size: 9px;
            max-height: 120px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .terminal-hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="window">
        <div class="titlebar">
            <div class="titlebar-text">LocalWrap</div>
        </div>
        
        <div class="content">
            <div class="section">
                <div class="section-title">Script & Server Control:</div>
                
                <!-- Working Directory -->
                <div style="margin-bottom: 8px;">
                    <label style="font-size: 10px; display: block; margin-bottom: 2px;">Working Directory:</label>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <input type="text" id="workingDirInput" placeholder="Current directory" readonly
                               style="flex: 1; height: 18px; border: 1px inset #f0f0f0; padding: 1px 4px; font-size: 10px; background: #f9f9f9;">
                        <button class="btn-small" onclick="selectWorkingDirectory()">Browse</button>
                        <button class="btn-small" onclick="resetWorkingDirectory()">Reset</button>
                    </div>
                </div>
                
                <!-- Script Input -->
                <div style="margin-bottom: 8px;">
                    <label style="font-size: 10px; display: block; margin-bottom: 2px;">Script Command:</label>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <input type="text" id="scriptInput" placeholder="npm start" 
                               style="flex: 1; height: 18px; border: 1px inset #f0f0f0; padding: 1px 4px; font-size: 10px;">
                        <select id="scriptPresets" onchange="setScriptPreset()" 
                                style="height: 20px; border: 1px inset #f0f0f0; font-size: 10px;">
                            <option value="">Presets...</option>
                            <option value="npm start">npm start</option>
                            <option value="npm run dev">npm run dev</option>
                            <option value="yarn start">yarn start</option>
                            <option value="yarn dev">yarn dev</option>
                            <option value="python -m http.server 3001">Python Server</option>
                            <option value="php -S localhost:3001">PHP Server</option>
                        </select>
                    </div>
                </div>
                
                <!-- Port and Controls -->
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <label style="font-size: 10px;">Port:</label>
                    <input type="number" id="portInput" value="3001" min="1000" max="65535" 
                           style="width: 60px; height: 18px; border: 1px inset #f0f0f0; padding: 1px 3px; font-size: 10px;">
                    <button class="btn-small" onclick="executeScript()">Run Script</button>
                    <button class="btn-small" onclick="stopScript()">Stop</button>
                    <button class="btn-small" onclick="createDesktopApp()">Desktop App</button>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title" onclick="toggleTerminal()" style="cursor: pointer;">
                    Terminal Output <span id="terminalToggle">[-]</span>
                </div>
                <div class="terminal-output" id="terminalOutput">
                    <div style="color: #666; font-size: 9px; padding: 4px;">Ready to execute scripts...</div>
                </div>
            </div>
            
        </div>
        
        <div class="status-bar" id="statusBar">
            Ready | No script running
        </div>
    </div>
    
    <div class="version-info">
        LocalWrap v1.0 - Desktop Development Server
    </div>

    <script>
        console.log('ðŸš€ LocalWrap JavaScript loading...');
        
        function updateStatusBar(message) {
            const statusBar = document.getElementById('statusBar');
            statusBar.textContent = message;
        }
        
        function showMessage(message, type) {
            const color = type === 'error' ? 'red' : 'green';
            console.log(`%c${message}`, `color: ${color}; font-weight: bold;`);
            
            // Update status bar
            updateStatusBar(message);
            const statusBar = document.getElementById('statusBar');
            statusBar.style.color = color;
            
            setTimeout(() => {
                const scriptStatus = currentProcess ? 'Script running' : 'No script running';
                updateStatusBar(`Ready | ${scriptStatus}`);
                statusBar.style.color = '';
            }, 3000);
        }
        
        // Script Management Functions
        let currentProcess = null;
        let currentWorkingDir = null;
        
        function setScriptPreset() {
            const preset = document.getElementById('scriptPresets').value;
            if (preset) {
                document.getElementById('scriptInput').value = preset;
                // Auto-update port based on preset
                if (preset.includes('3001')) {
                    document.getElementById('portInput').value = '3001';
                } else if (preset.includes('8000')) {
                    document.getElementById('portInput').value = '8000';
                }
            }
        }
        
        async function executeScript() {
            console.log('executeScript called');
            const script = document.getElementById('scriptInput').value.trim();
            const port = parseInt(document.getElementById('portInput').value);
            
            console.log('Script:', script, 'Port:', port);
            
            if (!script) {
                alert('Please enter a script command');
                return;
            }
            
            if (!port || port < 1000 || port > 65535) {
                alert('Please enter a valid port number (1000-65535)');
                return;
            }
            
            try {
                addTerminalOutput(`> Executing: ${script}`);
                addTerminalOutput(`> Target port: ${port}`);
                
                console.log('Making fetch request...');
                const response = await fetch('/api/script/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        script, 
                        port,
                        workingDir: currentWorkingDir 
                    })
                });
                
                console.log('Response received:', response.status);
                const result = await response.json();
                console.log('Result:', result);
                
                if (result.success) {
                    addTerminalOutput(`> Script started with PID: ${result.pid}`);
                    
                    // Show port change information if applicable
                    if (result.portMessage) {
                        addTerminalOutput(`> ${result.portMessage}`);
                        showMessage(`Script started on port ${result.port}`, 'success');
                        
                        // Update the port input to reflect the actual port used
                        document.getElementById('portInput').value = result.port;
                    } else {
                        showMessage('Script started successfully', 'success');
                    }
                    
                    if (result.actualCommand && result.actualCommand !== result.command) {
                        addTerminalOutput(`> Actual command: ${result.actualCommand}`);
                    }
                    
                    currentProcess = result.pid;
                    
                    // Update status bar
                    updateStatusBar(`Running: ${script} on port ${result.port}`);
                    
                    // Start polling for output
                    pollScriptOutput();
                } else {
                    addTerminalOutput(`> Error: ${result.error}`);
                    showMessage(result.error || 'Failed to start script', 'error');
                }
            } catch (error) {
                console.error('Execute script error:', error);
                addTerminalOutput(`> Error: ${error.message}`);
                showMessage('Error executing script: ' + error.message, 'error');
            }
        }
        
        async function stopScript() {
            if (!currentProcess) {
                showMessage('No script is currently running', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/script/stop/${currentProcess}`, { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    addTerminalOutput(`> Script stopped (PID: ${currentProcess})`);
                    currentProcess = null;
                    updateStatusBar('Ready | No script running');
                    showMessage('Script stopped', 'success');
                } else {
                    addTerminalOutput(`> Error stopping script: ${result.error}`);
                    showMessage(result.error || 'Failed to stop script', 'error');
                }
            } catch (error) {
                addTerminalOutput(`> Error: ${error.message}`);
                showMessage('Error stopping script: ' + error.message, 'error');
            }
        }
        
        async function createDesktopApp() {
            console.log('createDesktopApp called');
            const port = parseInt(document.getElementById('portInput').value);
            console.log('Port:', port);
            
            // Create a simple input dialog instead of using prompt()
            const appName = await showInputDialog('Enter desktop app name:', 'MyApp');
            console.log('App name:', appName);
            
            if (!appName) {
                console.log('No app name provided, returning');
                return;
            }
            
            try {
                console.log('Making desktop app creation request...');
                addTerminalOutput(`> Creating desktop app "${appName}"...`);
                addTerminalOutput(`> Installing dependencies and launching...`);
                showMessage('Creating desktop app...', 'success');
                
                const response = await fetch('/api/desktop-app/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ port, appName })
                });
                
                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Result:', result);
                
                if (result.success) {
                    if (result.launched) {
                        showMessage(`Desktop app "${appName}" created and launched!`, 'success');
                        addTerminalOutput(`> Desktop app created: ${result.path}`);
                        addTerminalOutput(`> Running script: ${result.script}`);
                        addTerminalOutput(`> Desktop app launched successfully!`);
                    } else {
                        showMessage(`Desktop app "${appName}" created successfully!`, 'success');
                        addTerminalOutput(`> Desktop app created: ${result.path}`);
                    }
                } else {
                    showMessage(result.error || 'Failed to create desktop app', 'error');
                    addTerminalOutput(`> Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Desktop app creation error:', error);
                showMessage('Error creating desktop app: ' + error.message, 'error');
                addTerminalOutput(`> Error: ${error.message}`);
            }
        }
        
        function showInputDialog(message, defaultValue) {
            return new Promise((resolve) => {
                // Create overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 1000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                
                // Create dialog
                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    background: #f0f0f0;
                    border: 2px outset #f0f0f0;
                    padding: 16px;
                    font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
                    font-size: 11px;
                    min-width: 300px;
                `;
                
                dialog.innerHTML = `
                    <div style="margin-bottom: 12px;">${message}</div>
                    <input type="text" id="dialogInput" value="${defaultValue}" 
                           style="width: 100%; height: 20px; border: 1px inset #f0f0f0; padding: 2px; font-size: 11px; margin-bottom: 12px;">
                    <div style="text-align: right;">
                        <button id="dialogOk" style="background: #f0f0f0; border: 1px outset #f0f0f0; padding: 3px 16px; margin-left: 6px; font-size: 11px; cursor: pointer; min-width: 75px;">OK</button>
                        <button id="dialogCancel" style="background: #f0f0f0; border: 1px outset #f0f0f0; padding: 3px 16px; margin-left: 6px; font-size: 11px; cursor: pointer; min-width: 75px;">Cancel</button>
                    </div>
                `;
                
                overlay.appendChild(dialog);
                document.body.appendChild(overlay);
                
                const input = document.getElementById('dialogInput');
                const okBtn = document.getElementById('dialogOk');
                const cancelBtn = document.getElementById('dialogCancel');
                
                input.focus();
                input.select();
                
                function cleanup() {
                    document.body.removeChild(overlay);
                }
                
                okBtn.onclick = () => {
                    const value = input.value.trim();
                    cleanup();
                    resolve(value);
                };
                
                cancelBtn.onclick = () => {
                    cleanup();
                    resolve(null);
                };
                
                input.onkeypress = (e) => {
                    if (e.key === 'Enter') {
                        okBtn.click();
                    } else if (e.key === 'Escape') {
                        cancelBtn.click();
                    }
                };
            });
        }
        
        function addTerminalOutput(text) {
            const terminal = document.getElementById('terminalOutput');
            const timestamp = new Date().toLocaleTimeString();
            terminal.innerHTML += `\n[${timestamp}] ${text}`;
            terminal.scrollTop = terminal.scrollHeight;
        }
        
        function toggleTerminal() {
            const terminal = document.getElementById('terminalOutput');
            const toggle = document.getElementById('terminalToggle');
            
            if (terminal.classList.contains('terminal-hidden')) {
                terminal.classList.remove('terminal-hidden');
                toggle.textContent = '[-]';
            } else {
                terminal.classList.add('terminal-hidden');
                toggle.textContent = '[+]';
            }
        }
        
        async function pollScriptOutput() {
            if (!currentProcess) return;
            
            try {
                const response = await fetch(`/api/script/output/${currentProcess}`);
                const result = await response.json();
                
                // Only add new output lines (backend now returns only new lines)
                if (result.success && result.output && result.output.length > 0) {
                    result.output.forEach(line => {
                        if (line.trim()) { // Only add non-empty lines
                            addTerminalOutput(line);
                        }
                    });
                }
                
                // Continue polling if process is still running
                if (result.running) {
                    setTimeout(pollScriptOutput, 2000); // Reduced frequency to 2 seconds
                } else {
                    currentProcess = null;
                    updateStatusBar('Ready | No script running');
                    addTerminalOutput('> Script finished');
                }
            } catch (error) {
                console.error('Error polling script output:', error);
            }
        }
        
        // Working Directory Management
        async function selectWorkingDirectory() {
            try {
                const response = await fetch('/api/select-directory', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success && result.path) {
                    currentWorkingDir = result.path;
                    document.getElementById('workingDirInput').value = result.path;
                    addTerminalOutput(`> Working directory set to: ${result.path}`);
                    showMessage('Working directory updated', 'success');
                } else if (result.cancelled) {
                    // User cancelled, do nothing
                } else {
                    showMessage('Failed to select directory', 'error');
                }
            } catch (error) {
                console.error('Directory selection error:', error);
                showMessage('Error selecting directory: ' + error.message, 'error');
            }
        }
        
        function resetWorkingDirectory() {
            currentWorkingDir = null;
            document.getElementById('workingDirInput').value = '';
            document.getElementById('workingDirInput').placeholder = 'Current directory';
            addTerminalOutput('> Working directory reset to current directory');
            showMessage('Working directory reset', 'success');
        }
        
        // Initialize working directory display
        window.addEventListener('load', async () => {
            try {
                const response = await fetch('/api/current-directory');
                const result = await response.json();
                if (result.success) {
                    document.getElementById('workingDirInput').placeholder = result.path;
                }
            } catch (error) {
                console.error('Failed to get current directory:', error);
            }
        });
    </script>
</body>
</html>